jobs:
  Create-Environments:
    runs-on: ubuntu-latest
    env:
      RUNNER_DEBUG: 1

    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true

      # Installiere Power Apps CLI (PAC)
      - name: Install Power Apps CLI
        run: |
          curl -sSL https://aka.ms/get-app-cli | bash

      - name: Create Developer Environment
        uses: microsoft/powerplatform-actions/create-environment@v1.8.0
        with:
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.POWERPLATFORMSPN }}
          tenant-id: ${{ secrets.TENANT_ID }}
          name: ${{ github.event.inputs.env_name }}_Dev
          type: Developer
          domain: ${{ github.event.inputs.env_name }}Dev
  
      - name: assign-user to developer environment
        uses: microsoft/powerplatform-actions/assign-user@v1.8.0
        with:
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.POWERPLATFORMSPN }}
          tenant-id: ${{ secrets.TENANT_ID }}
          environment: 'https://${{ github.event.inputs.env_name }}Dev.dynamics.com'
          user: ${{ github.event.inputs.user_id }}
          role: System Administrator
  
      - name: Create Test Environment
        uses: microsoft/powerplatform-actions/create-environment@v1.8.0
        with:
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.POWERPLATFORMSPN }}
          tenant-id: ${{ secrets.TENANT_ID }}
          name: ${{ github.event.inputs.env_name }}_Test
          type: Sandbox
          domain: ${{ github.event.inputs.env_name }}Test
  
      - name: assign-user to test environment
        uses: microsoft/powerplatform-actions/assign-user@v1.8.0
        with:
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.POWERPLATFORMSPN }}
          tenant-id: ${{ secrets.TENANT_ID }}
          environment: 'https://${{ github.event.inputs.env_name }}Test.crm.dynamics.com'
          user: ${{ github.event.inputs.user_id }}
          role: System Administrator
  
      - name: Create Production Environment
        uses: microsoft/powerplatform-actions/create-environment@v1.8.0
        with:
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.POWERPLATFORMSPN }}
          tenant-id: ${{ secrets.TENANT_ID }}
          name: ${{ github.event.inputs.env_name }}_Prod
          type: Production
          domain: ${{ github.event.inputs.env_name }}Prod
  
      - name: assign-user to Prod environment
        uses: microsoft/powerplatform-actions/assign-user@v1.8.0
        with:
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.POWERPLATFORMSPN }}
          tenant-id: ${{ secrets.TENANT_ID }}
          environment: 'https://${{ github.event.inputs.env_name }}Prod.crm.dynamics.com'
          user: ${{ github.event.inputs.user_id }}
          role: System Administrator
