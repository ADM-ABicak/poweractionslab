name: Create Dev Test and Prod Environments
# clean up the environment for the next demo
# clean up environment tasks for QA and Prod

on:
  workflow_dispatch:
    inputs:
      env_name:
        description: 'Name for the environment to be created'
        required: true
        default: '107 Aykut' # Default value, change as needed
      client_id: 
        description: 'Service principal client id'
        required: true
        default: '3d50fc54-97a3-40d1-b976-ef0af2206189' # Deine Client-ID
      user_id: 
        description: 'AAD object id for the user'
        required: true
        default: '707f9714-00fd-4939-95ac-4cb3f931ad00' # Replace with default value or leave as placeholder

# Do Not change these values

jobs:
  Create-Environments:
    runs-on: ubuntu-latest
    env:
      RUNNER_DEBUG: 1

    steps:
    - uses: actions/checkout@v3
      with:
        lfs: true

    - name: Sanitize env_name
      id: sanitize_env_name
      run: |
        sanitized_name="${{ github.event.inputs.env_name }}"

        # Replace spaces with hyphens
        sanitized_name=$(echo "$sanitized_name" | sed 's/ /-/g')

        echo "sanitized_name=$sanitized_name" >> $GITHUB_ENV

    - name: Create Developer Environment
      uses: microsoft/powerplatform-actions/create-environment@latest
      with:
        app-id: ${{ secrets.CLIENT_ID }}
        client-secret: ${{ secrets.POWERPLATFORMSPN }}
        tenant-id: ${{ secrets.TENANT_ID }}
        name: ${{ github.event.inputs.env_name }}_Dev
        type: Developer
        domain: ${{ env.sanitized_name }}Dev

    - name: assign-user to developer environment
      uses: microsoft/powerplatform-actions/assign-user@vlatest
      with:
        app-id: ${{ secrets.CLIENT_ID }}
        client-secret: ${{ secrets.POWERPLATFORMSPN }}
        tenant-id: ${{ secrets.TENANT_ID }}
        environment: 'https://${{ env.sanitized_name }}Dev.dynamics.com'
        user: ${{ github.event.inputs.user_id }}
        role: System Administrator

    - name: Create Test Environment
      uses: microsoft/powerplatform-actions/create-environment@vlatest
      with:
        app-id: ${{ secrets.CLIENT_ID }}
        client-secret: ${{ secrets.POWERPLATFORMSPN }}
        tenant-id: ${{ secrets.TENANT_ID }}
        name: ${{ github.event.inputs.env_name }}_Test
        type: Sandbox
        domain: ${{ env.sanitized_name }}Test

    - name: assign-user to test environment
      uses: microsoft/powerplatform-actions/assign-user@vlatest
      with:
        app-id: ${{ secrets.CLIENT_ID }}
        client-secret: ${{ secrets.POWERPLATFORMSPN }}
        tenant-id: ${{ secrets.TENANT_ID }}
        environment: 'https://${{ env.sanitized_name }}Test.crm.dynamics.com'
        user: ${{ github.event.inputs.user_id }}
        role: System Administrator

    - name: Create Production Environment
      uses: microsoft/powerplatform-actions/create-environment@vlatest
      with:
        app-id: ${{ secrets.CLIENT_ID }}
        client-secret: ${{ secrets.POWERPLATFORMSPN }}
        tenant-id: ${{ secrets.TENANT_ID }}
        name: ${{ github.event.inputs.env_name }}_Prod
        type: Production
        domain: ${{ env.sanitized_name }}Prod

    - name: assign-user to Prod environment
      uses: microsoft/powerplatform-actions/assign-user@vlatest
      with:
        app-id: ${{ secrets.CLIENT_ID }}
        client-secret: ${{ secrets.POWERPLATFORMSPN }}
        tenant-id: ${{ secrets.TENANT_ID }}
        environment: 'https://${{ env.sanitized_name }}Prod.crm.dynamics.com'
        user: ${{ github.event.inputs.user_id }}
        role: System Administrator
